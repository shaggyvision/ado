<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Chatbot Recaudaci칩n - Demo (con Avatar y Voz) - Mejorado</title>
<style>
:root{
  --bg:#e5ddd5;
  --me:#25d366;
  --me-text:#002b18;
  --bot:#ffffff;
  --bot-text:#111;
  --accent:#6A0DAD;
  --accent2:#8E44AD;
  --muted:#888;
  --chat-width:420px;
}
body{
  background: linear-gradient(180deg,#f2f2f2,#e9eef0);
  font-family: Inter, "Segoe UI", Roboto, sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  margin:0;
}
.container{
  width: min(var(--chat-width), 96vw);
  height: 88vh;
  background: #f7f7f7;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(15,20,25,0.12);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.header {
  padding: 12px;
  background: linear-gradient(90deg, var(--accent), #0b8b72);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}
.header .info { display:flex; align-items:center; gap:10px; }
.avatar { width: 42px; height: 42px; border-radius: 50%; background: white;
  display: flex; align-items: center; justify-content: center; flex: 0 0 42px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
}
.header .title { font-weight: 700; color: white; }
.header img { height: 42px; }
.chat{
  flex:1;
  padding:16px;
  overflow-y:auto;
  overflow-x:hidden;
  display:flex;
  flex-direction:column;
  gap:10px;
  scroll-behavior:smooth;
  background:
    radial-gradient(circle at top left, rgba(255,255,255,0.6), transparent 10%),
    var(--bg);
}
.chat::-webkit-scrollbar { width: 8px; }
.chat::-webkit-scrollbar-thumb { background-color: var(--accent); border-radius: 8px; }
.chat::-webkit-scrollbar-track { background: #eee; border-radius: 8px; }
.bubble{ max-width:78%; padding:10px 12px; border-radius:12px; line-height:1.3; box-shadow: 0 1px 0 rgba(0,0,0,0.04); word-wrap:break-word; }
.bot{ align-self:flex-start; background:var(--bot); color:var(--bot-text); border-bottom-left-radius:4px; }
.me{ align-self:flex-end; background:var(--me); color:var(--me-text); border-bottom-right-radius:4px; }
.time{ display:block; font-size:11px; color:var(--muted); margin-top:6px; }
.options{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
.option-btn{ background:rgba(0,0,0,0.06); border:0; padding:8px 12px; border-radius:20px; cursor:pointer; font-weight:600; }
.option-btn:hover{ filter:brightness(.98) }
.option-btn.primary{ background:var(--accent); color:white; }
.footer{ padding:10px; border-top:1px solid rgba(0,0,0,0.06); display:flex; gap:8px; align-items:center; background:white; }
.restart{ margin-left:auto; background:transparent; border:1px solid rgba(0,0,0,0.08); padding:6px 10px; border-radius:8px; cursor:pointer; }
.link-card { display:block; margin-top:8px; padding:8px; border-radius:8px; background: transparent; border: none; text-decoration:none; color: inherit; }
.small{ font-size:13px; color:var(--muted); }

.lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 9999; }
.lightbox iframe { width: 90%; height: 80%; border: none; border-radius: 8px; }
.close-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; font-size: 18px; padding: 8px 14px; border-radius: 8px; cursor: pointer; transition: background 0.2s; z-index: 10000; }
.close-btn:hover { background: rgba(255,255,255,0.4); }

/* Floating avatar positioned bottom-right above restart button */
#robot-avatar {
  position: fixed;
  right: 18px;
  bottom: 92px; /* sits above the restart button inside the container */
  width: 120px;
  z-index: 10002;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  pointer-events: auto;
  user-select: none;
}
.robot-card {
  width:120px;
  background: linear-gradient(180deg,#f3f4f6,#eceff1);
  border-radius:16px;
  padding:8px;
  box-shadow: 0 8px 30px rgba(15,20,25,0.14);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}
.robot-face {
  width:84px;
  height:84px;
  border-radius:16px;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}
.robot-face img{ width:100%; height:100%; object-fit:cover; display:block; }

#mic-btn{
  background: var(--accent);
  color:#fff;
  border: none;
  padding: 8px 12px;
  border-radius: 999px;
  cursor:pointer;
  font-weight:700;
  display:flex;
  align-items:center;
  gap:8px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}
#mic-btn.listening { background: #e63946; box-shadow: 0 2px 8px rgba(230,57,70,0.16); transform: translateY(-2px); }
#mic-indicator { font-size:12px; color:var(--muted); }

@media (max-width:600px){
  #robot-avatar { right: 10px; bottom: 84px; width:100px; }
  .robot-card { width:100px; padding:8px; }
}
button:focus { outline: 3px solid rgba(106,13,173,0.2); outline-offset:2px; }
</style>
</head>
<body>



</div>
</div>
<div aria-label="Chatbot Recaudaci칩n" class="container" role="application">
<div class="header">
<div class="info">
<div aria-hidden="true" class="avatar">
<img alt="Robot asistente" src="https://cdn-icons-png.flaticon.com/512/6231/6231457.png"/>
</div>
<div>
<div class="title">Asistente Abordo</div>
<div class="small">Recaudacion VHT</div>
</div>
</div>
<img alt="Logo Mobility ADO" src="https://www.mobilityado.com/assets/images/footer-logo.png"/>
</div>
<div aria-live="polite" class="chat" id="chat"></div>
<div class="footer">
<div class="small">Selecciona una opci칩n para continuar</div>
<button class="restart" id="restart" title="Reiniciar">Reiniciar</button>
</div>
</div>
<script>
/* helpers */
function openLightbox(videoUrl) {
  const lb = document.getElementById('lightbox');
  const frame = document.getElementById('lightboxFrame');
  frame.src = videoUrl;
  lb.style.display = 'flex';
  lb.setAttribute('aria-hidden', 'false');
}
function openPdf(pdfUrl) {
  const lb = document.getElementById('lightbox');
  const frame = document.getElementById('lightboxFrame');
  lb.style.display = 'flex';
  lb.style.background = 'rgba(0, 0, 0, 0.7)';
  const viewerUrl = 'https://docs.google.com/gview?embedded=true&url=' + encodeURIComponent(pdfUrl);
  frame.style.background = '#fff';
  frame.src = viewerUrl;
  lb.setAttribute('aria-hidden', 'false');
}
function closeLightbox() {
  const lb = document.getElementById('lightbox');
  const frame = document.getElementById('lightboxFrame');
  frame.src = '';
  lb.style.display = 'none';
  lb.setAttribute('aria-hidden', 'true');
}

/* chat core */
const chatEl = document.getElementById('chat');
const restartBtn = document.getElementById('restart');

function nowTime(){ const d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function scrollEnd(){ setTimeout(()=> chatEl.scrollTop = chatEl.scrollHeight, 80); }

/* voice/read flags */
let lastInputWasVoice = false; // set true when user spoke
let suppressBotSpeak = false;  // used to avoid double-reading after confirmation
const speakResponsesWhenUserSpoke = true; // per user's preference

function addBotBubble(html, options=null){
  const wrap = document.createElement('div');
  wrap.className = 'bubble bot';
  wrap.innerHTML = html;
  const time = document.createElement('div');
  time.className = 'time';
  time.textContent = nowTime();
  wrap.appendChild(time);

  chatEl.appendChild(wrap);

  if(options){
    const optDiv = document.createElement('div');
    optDiv.className = 'options';
    options.forEach(opt=>{
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      if(opt.primary) btn.classList.add('primary');
      btn.innerText = opt.label;
      btn.onclick = ()=> handleOption(opt);
      optDiv.appendChild(btn);
    });
    chatEl.appendChild(optDiv);
  }
  scrollEnd();

  // speak bot text only when appropriate (user used voice)
  const clean = html.replace(/<[^>]*>/g, '');
  if(!suppressBotSpeak){
    speak(clean);

    lastInputWasVoice = false;
  } else if(suppressBotSpeak){
    suppressBotSpeak = false;
    lastInputWasVoice = false;
  }
}

function addUserBubble(text){
  const wrap = document.createElement('div');
  wrap.className = 'bubble me';
  wrap.textContent = text;
  const time = document.createElement('div');
  time.className = 'time';
  time.textContent = nowTime();
  wrap.appendChild(time);
  chatEl.appendChild(wrap);
  scrollEnd();
}

/* nodes (unchanged content) */
const nodes = {
  main: {
    type:'question',
    id:'main',
    prompt: 'Hola, soy tu asistente virtual de Recaudaci칩n, y estoy para responder tus dudas, deseas iniciar?',
    options:[
      {id:'SI', label:'SI', next:'menuPrincipal'},
      {id:'NO', label:'NO', next:'endNo'}
    ]
  },
  endNo:{ type:'message', id:'endNo', text:'Perfecto. Si necesitas ayuda despu칠s, puedes reiniciar el chat.'},

  menuPrincipal:{
    type:'question',
    id:'menuPrincipal',
    prompt: 'ELIJE UNA OPCION',
    options:[
      {id:'SUELDOS Y CARTERA', label:'SUELDOS Y CARTERA', next:'sueldo_menu'},
      {id:'INCENTIVOS', label:'INCENTIVOS', next:'incentivos marca'},
      {id:'PROCESO COVA', label:'PROCESO COVA', next:'proceso cova'},
      {id:'CREDITOS_EXTERNOS', label:'CREDITOS EXTERNOS', next:'creditos externos'},
      {id:'HABLAR CON UN ASESOR', label:'HABLAR CON UN ASESOR', next:'hablar asesor'}
    ]
  },

  hablar_asesor:{
    type:'message',
    id:'hablar_asesor',
    text: 'Si deseas hablar con un asesor, haz clic en el enlace de atenci칩n. (Abrir치 una p치gina externa).',
attachments: [{type:'image', url:'https://shaggyvision.github.io/ado/WHATS-removebg-preview.png', link:'https://wa.me/+529372547287?text=hola'}]
  },

  sueldo_menu:{
    type:'question',
    id:'sueldo_menu',
    prompt: 'SELECCIONA UNA OPCION',
    options:[
      {id:'FACTOR_PASAJERO', label:'쮺u치nto debo de ingresar para alcanzar Factor Pasajero?', next:'factor_pasajero'},
      {id:'COMO_CALCULO_SUELDO', label:'쮺칩mo c치lculo mi sueldo?', next:'calcula_sueldo_marca'},
      {id:'QUE_CONCEPTOS', label:'쯈u칠 conceptos me descuentan en N칩mina?', next:'conceptos_nomina'},
      {id:'CUANTO_ISR', label:'쮺u치nto me descuentan  de ISR al mes?', next:'cuanto_isr_marca'},
      {id:'CUANTO_IMSS', label:'쮺u치nto me descuentan  de IMSS al mes?', next:'cuanto_imss_marca'},
      {id:'CUOTA_SINDICAL', label:'쮺칩mo se calcula la  Cuota sindical al mes?', next:'cuota_sindical_marca'},
      {id:'DESCUENTO_FONDO', label:'쮺u치nto es el descuento de Fondo de ahorro?', next:'descuento_fondo_marca'},
      {id:'FECHA_FONDO', label:'쮺u치l es la fecha l칤mite para cubrir mi Fondo de Ahorro?', next:'fecha_fondo'},
      {id:'QUE_SON_EXCEDENTES', label:'쯈u칠 son los excedentes?', next:'excedentes'},
      {id:'CUANTO_IMPUESTOS', label:'쮺u치nto debo de impuestos?', next:'impuestos_link'},
      {id:'REGRESAR', label:'REGRESAR', next:'menuPrincipal'}
    ]
  },

  factor_pasajero:{
    type:'message',
    id:'factor_pasajero',
    text: 'Te invitamos a usar la siguiente aplicaci칩n, donde podr치s tener el factor m칤nimo de las corridas donde operas.',
    attachments: [{type:'image', url:'https://shaggyvision.github.io/ado/CONSULTA-removebg-preview.png', link:'https://n9.cl/xlctvd'}]
  },

  calcula_sueldo_marca:{
    type:'question',
    id:'calcula_sueldo_marca',
    prompt:'SELECCIONA TU MARCA',
    options:[
      {id:'ADO', label:'ADO', next:'calculo_sueldo_ADO'},
      {id:'TRT', label:'TRT/SUR INTERMEDIO', next:'calculo_sueldo_TRT'},
      {id:'VOLKBUS', label:'VOLKBUS', next:'calculo_sueldo_VOLKBUS'},
      {id:'REGRESAR', label:'REGRESAR', next:'sueldo_menu'}
    ]
  },

  calculo_sueldo_ADO:{
    type:'message',
    id:'calculo_sueldo_ADO',
    text:`Identifica el ingreso total de tu viaje sin IVA y div칤delo entre el precio del boleto de tu viaje realizado; el resultado ser치 tu factor pasajero.
Localiza el factor pasajero en la Tabla de pago que te corresponda y toma el factor que se ubica en la columna PK y PP.
Multiplica el factor PK por el kilometraje realizado en tu viaje y obtendr치s el pago por kil칩metro.
Multiplica el factor PP por el kilometraje realizado en tu viaje y obtendr치s el pago por pasajero transportado.
La suma de ambos pagos es el sueldo bruto que percibir치s por el viaje realizado antes de impuestos o descuentos de cartera.
Si tienes dudas te invitamos a que visualices el siguiente video:`,
    attachments:[{type:'video', url:'<iframe src="https://player.vimeo.com/video/1104559211?h=15cdc4e413" width="340" height="360" frameborder="0" allowfullscreen></iframe>'}]},

  calculo_sueldo_TRT:{
    type:'message',
    id:'calculo_sueldo_TRT',
    text:`Identifica el ingreso total de tu viaje sin IVA multipl칤calo por el 95%; y el resultado div칤delo entre el total de kilometros recorridos; esto nos da tu factor ingreso-kil칩metro;
Ubica tu FIK en la tabla de pago, entre el rango m칤nimo,medio y m치ximo tomando el factor que se ubica en las columnas PK y PP;
Multiplica el factor de la columna PK por el total de kil칩metros y esto nos dar치 el pago por kilometraje;
Multiplica el factor de la columna PP por el total de kil칩metros y esto nos dar치 el pago por pasajero transportado;
La suma de ambos pagos es considerado como tu sueldo bruto antes de impuestos u otros descuentos de cartera.
Si tienes dudas te invitamos a que visualices el siguiente video:`,
    attachments:[{type:'video', url:'<iframe src="https://player.vimeo.com/video/1104559136?h=bfe7ba53ad" width="340" height="360" frameborder="0" allowfullscreen></iframe>'}]},

  calculo_sueldo_VOLKBUS:{
    type:'message',
    id:'calculo_sueldo_VOLKBUS',
    text:`Debes de tener en cuenta que tu c치lculo se genera de manera semanal tomando el corte de LUNES a DOMINGO; Identifica el total de tus ingresos de tus secuencias realizadas por d칤a y div칤delo entre el total de tus kil칩metros recorridos; esto nos dar치 el factor INGRESO-KILOMETRO: FIK; Ubica tu FIK en la tabla de pago, entre el rango m칤nimo, medio y superior toma el factor de la columna total y multipl칤calo por los kil칩metros  recorridos; el resultado ser치 tu comisi칩n diaria; El proceso se repite por cada uno de los d칤as de la semana laborados para as칤 obtener tu comisi칩n semanal antes de impuestos u otros descuentos de cartera; Recuerda que tienes un sueldo de garant칤a el cual se te pagar치 en caso de no haber obtenido factor. Si tienes dudas te invitamos a que visualices el siguiente video: `,
    attachments:[{type:'video', url:'<iframe src="https://player.vimeo.com/video/1104558946?h=5c22c1a9b4" width="340" height="360" frameborder="0" allowfullscreen></iframe>'}]},


  conceptos_nomina:{ type:'message', id:'conceptos_nomina', text:'IMSS, ISR, INFONAVIT, Anticipo de Sueldo, Gastos no comprobados, Pistas no comprobadas, Uniformes, Fonacot, Paga Da침os e Inspecci칩n.'},

  cuanto_isr_marca:{
    type:'question',
    id:'cuanto_isr_marca',
    prompt:'SELECCIONA TU MARCA',
    options:[
      {id:'ADO', label:'ADO', next:'isr_ADO'},
      {id:'TRT', label:'TRT/SUR INTERMEDIO', next:'isr_TRT'},
      {id:'VOLKBUS', label:'VOLKBUS', next:'isr_VOLKBUS'},
      {id:'REGRESAR', label:'REGRESAR', next:'sueldo_menu'}
    ]
  },
  isr_ADO:{ type:'message', id:'isr_ADO', text:'Por 28 d칤as $2,463.85, Por 30 d칤as $2,639.84, por 31 d칤as $2,727.83.'},
  isr_TRT:{ type:'message', id:'isr_TRT', text:'Por 28 d칤as $1,732.06, Por 30 d칤as $1,855.78, por 31 d칤as $1,917.64.'},
  isr_VOLKBUS:{ type:'message', id:'isr_VOLKBUS', text:'T칰 perteneces al regimen General de Ley, por lo tanto tus impuestos, van en funci칩n a tus percepciones brutas.'},

  cuanto_imss_marca:{
    type:'question',
    id:'cuanto_imss_marca',
    prompt:'SELECCIONA TU MARCA',
    options:[
      {id:'ADO', label:'ADO', next:'imss_ADO'},
      {id:'TRT', label:'TRT/SUR INTERMEDIO', next:'imss_TRT'},
      {id:'VOLKBUS', label:'VOLKBUS', next:'imss_VOLKBUS'},
      {id:'REGRESAR', label:'REGRESAR', next:'sueldo_menu'}
    ]
  },
  imss_ADO:{ type:'message', id:'imss_ADO', text:'Por 28 d칤as $873.61, Por 30 d칤as $936.01, por 31 d칤as $967.21.'},
  imss_TRT:{ type:'message', id:'imss_TRT', text:'Por 28 d칤as $602.85, Por 30 d칤as $645.91, por 31 d칤as $667.44.'},
  imss_VOLKBUS:{ type:'message', id:'imss_VOLKBUS', text:'Tu perteneces al regimen General de Ley, por lo tanto tus impuestos, van en funci칩n a tus percepciones brutas.'},

  cuota_sindical_marca:{
    type:'question',
    id:'cuota_sindical_marca',
    prompt:'SELECCIONA TU MARCA',
    options:[
      {id:'ADO', label:'ADO', next:'cuota_ADO'},
      {id:'TRT', label:'TRT/SUR INTERMEDIO', next:'cuota_TRT'},
      {id:'VOLKBUS', label:'VOLKBUS', next:'cuota_VOLKBUS'},
      {id:'REGRESAR', label:'REGRESAR', next:'sueldo_menu'}
    ]
  },
  cuota_ADO:{ type:'message', id:'cuota_ADO', text:'Se multiplica $11.50 por todos los dias trabajados del mes inmediato anterior.'},
  cuota_TRT:{ type:'message', id:'cuota_TRT', text:'Se descuenta el 2% sobre tu percepci칩n del viaje realizado.'},
  cuota_VOLKBUS:{ type:'message', id:'cuota_VOLKBUS', text:'Se descuenta el 2% sobre tu percepci칩n de los  viajes realizados. '},

  descuento_fondo_marca:{
    type:'question',
    id:'descuento_fondo_marca',
    prompt:'SELECCIONA TU MARCA',
    options:[
      {id:'ADO', label:'ADO', next:'fondo_ADO'},
      {id:'SUR', label:'SUR INTERMEDIO', next:'fondo_SUR'},
      {id:'TRT_INTERMEDI', label:'TRT INTERMEDI', next:'fondo_TRT_INTERMEDI'},
      {id:'VOLKBUS', label:'VOLKBUS', next:'fondo_VOLKBUS'},
      {id:'REGRESAR', label:'REGRESAR', next:'sueldo_menu'}
    ]
  },
  fondo_ADO:{ type:'message', id:'fondo_ADO', text:'$1,587.78 mensual'},
  fondo_SUR:{ type:'message', id:'fondo_SUR', text:'$1,013.64 mensual'},
  fondo_TRT_INTERMEDI:{ type:'message', id:'fondo_TRT_INTERMEDI', text:'$1,013.64 mensual'},
  fondo_VOLKBUS:{ type:'message', id:'fondo_VOLKBUS', text:'Tu contrato colectivo no cuenta con esta prestaci칩n'},

  fecha_fondo:{ type:'message', id:'fecha_fondo', text:'Tienes hasta el 칰ltimo d칤a del mes, siempre y cuando hayas cubierto tu deuda de cartera (IMSS,ISR,INFONAVIT,PAGO x DA칌OS).'},

  excedentes:{ type:'message', id:'excedentes', text:'Son los montos de impuestos que no alcanzaste a cubrir dentro del mes (ISR, IMSS e INFONAVIT).'},

  impuestos_link:{
    type:'message',
    id:'impuestos_link',
    text:'Para una mejor administraci칩n de tus finanzas te invito a consultar el siguiente Link de App Saldos por conductor.',
    attachments:[{type:'image', url:'https://shaggyvision.github.io/ado/SALDOS-removebg-preview.png', link:'https://n9.cl/31e71t'}]
  },

  incentivos_marca:{
    type:'question',
    id:'incentivos_marca',
    prompt:'SELECCIONA TU MARCA',
    options:[
      {id:'INC_ADO', label:'ADO', next:'incentivos_ADO'},
      {id:'INC_TRT', label:'TRT/SUR INTERMEDIO', next:'incentivos_TRT'},
      {id:'INC_VOLKBUS', label:'VOLKBUS', next:'incentivos_VOLKBUS'},
      {id:'REGRESAR', label:'REGRESAR', next:'menuPrincipal'}
    ]
  },

  incentivos_ADO:{
    type:'question',
    id:'incentivos_ADO',
    prompt:'ESTOS SON LOS DIFERENTES INCENTIVOS QUE RECIBES, SELECCIONA ALGUNO PARA SABER MAS',
    options:[
      {id:'ICO', label:'ICO', next:'ico_msg'},
      {id:'INS', label:'INS', next:'ins_msg'},
      {id:'REGRESAR', label:'REGRESAR', next:'incentivos_marca'}
    ]
  },
  ico_msg:{ type:'message', id:'ico_msg', text:'Es el Incentivo por Cumplimiento Operativo.  Aplica para los conductores que hayan trabajado durante todo el mes de acuerdo a su contrato colectivo sin registrar ninguna incidencia como por ejemplo: falta, permiso, curso de reforzamiento, baja, suspensi칩n, incapacidad; se paga de manera mensual  a partir del d칤a 15 de cada mes.   '},
  ins_msg:{ type:'message', id:'ins_msg', text:'Es el Incentivo por No Siniestralidad. Su pago se genera en dos tipos: 1.- Cuatrimestral, de ENERO-ABRIL; MAYO-AGOSTO; SEPTIEMBRE-DICIEMBRE el cual se paga tres veces al a침o a partir del d칤a 18 del mes inmediato de cada cuatrimestre; 2.- El anual, se gana al haber obtenido los tres pagos cuatrimestrales; se determina del 1 de septiembre al 31 de agosto del a침o siguiente y su pago se realiza a partir del d칤a 18 de octubre. Para obtener este incentivo  recuerda cumplir con el 65% o m치s del kilometraje programado por regi칩n, marca y zona y no tener accidente con responsabilidad. '},

  incentivos_TRT:{
    type:'question',
    id:'incentivos_TRT',
    prompt:'ESTOS SON LOS DIFERENTES INCENTIVOS QUE RECIBES, SELECCIONA ALGUNO PARA SABER MAS',
    options:[
      {id:'IBECC', label:'IBECC', next:'ibecc_msg'},
      {id:'ICO', label:'ICO', next:'ico_msg'},
      {id:'INS', label:'INS', next:'ins_msg'},
      {id:'REGRESAR', label:'REGRESAR', next:'incentivos_marca'}
    ]
  },
  ibecc_msg:{ type:'message', id:'ibecc_msg', text:'Es el Incentivo por Boleto Efectivo Cortado en Camino. Su c치lculo es del d칤a 1 al 30 de cada mes  y su pago se realiza a partir del dia 5 del siguiente mes; Aplica para conductor de intermedio sin ayudante y se determina por la venta a bordo realizada, Puedes obtenerlo siempre y cuando no tengas ning칰n reporte de INSPECCION ni anomalias de AVA.'},
  incentivos_VOLKBUS:{ type:'message', id:'incentivos_VOLKBUS', text:'Tu contrato colectivo no cuenta con un esquema de incentivos.'},

  proceso_cova:{
    type:'question',
    id:'proceso_cova',
    prompt:'PROCESO COVA',
    options:[
      {id:'ACCIDENTE_SIIAB', label:'쯈u칠 hacer en caso de accidente o falla siiab?', next:'accidente_siiab'},
      {id:'NO_REPORTE_FIN_TURNO', label:'쯈u칠 hago si la SIIAB no me di칩 el reporte y el fin de turno ?', next:'no_reporte_fin_turno'},
      {id:'MAQUINA_FALLO', label:'쯈u칠 debo hacer si la m치quina SIIAB fall칩 y emiti칩 boletos de m치s?', next:'maquina_fallo'},
      {id:'DATOS_TARJETA_INCORRECTOS', label:'쯈u칠 hago si los datos de mi tarjeta de viaje no est치n correctos? ', next:'datos_tarjeta'},
      {id:'REQUISITOS_LIQUIDAR', label:'쯈u칠 requisitos debo tener para liquidar mi viaje en Recaudaci칩n?', next:'requisitos_liquidar'},
      {id:'TERMINALES_AUTORIZADAS', label:'쮺u치les son las terminales autorizadas para realizar depositos en camino?', next:'terminales_autorizadas'},
      {id:'COMPROBANTE_LIQUIDACION', label:'쮺u치l es mi comprobante de liquidaci칩n?', next:'comprobante_liquidacion'},
      {id:'REGRESAR', label:'REGRESAR', next:'menuPrincipal'}
    ]
  },

  accidente_siiab:{ type:'message', id:'accidente_siiab', text:'Rep칩rtalo al 55-32-24-13-21 o bien haz click en el siguiente boton.', attachments:[{type:'link', title:'游뚧 CONTIGO EN CAMINO 游', url:'https://shaggyvision.github.io/ado/CONTIGOENELCAMINO.pdf'}]},
  no_reporte_fin_turno:{ type:'message', id:'no_reporte_fin_turno', text:'Rep칩rtalo con tr치fico y solicita un detallado de tu venta en el 치rea de Recaudaci칩n.'},
  maquina_fallo:{ type:'message', id:'maquina_fallo', text:'Levanta un reporte en el 치rea de mantenimiento y solicita un pase de aclaraci칩n por cancelaci칩n con tu preceptor y recaba firma del Gerente de Operaciones.'},
  datos_tarjeta:{ type:'message', id:'datos_tarjeta', text:'No la aceptes y pide en ese momento una nueva tarjeta con los controladores de tr치fico.'},
  requisitos_liquidar:{ type:'message', id:'requisitos_liquidar', text:'Tarjeta de viaje confirmada por tr치fico, efectivo, boletos de canjes, dep칩sitos en camino y gastos autorizados.', attachments:[{type:'video', url:'<iframe src="https://player.vimeo.com/video/1104559098?h=575d0fcf42" width="340" height="360" frameborder="0" allowfullscreen></iframe>'}]},

  terminales_autorizadas:{ type:'message', id:'terminales_autorizadas', text:'Recaudaci칩n C치rdenas, Terminal Coatzacoalcos, Terminal La Venta, Terminal C치rdenas, Catab, Terminal Emiliano Zapata, Terminal Tenosique, Terminal Ciudad del Carmen, Recaudaci칩n Tuxtla, Terminal Tuxtla, Terminal M칠rida.'},
  comprobante_liquidacion:{ type:'message', id:'comprobante_liquidacion', text:'Al t칠rmino de tu liquidaci칩n; siempre que no debas AVA o abones a tu deuda, el 치rea de Recaudaci칩n te emitir치 un PASE DE NO ADEUDO.'},

  creditos_externos:{
    type:'question',
    id:'creditos_externos',
    prompt:'SELECCIONA EL TIPO DE CREDITO',
    options:[
      {id:'INFONAVIT', label:'INFONAVIT', next:'infonavit'},
      {id:'FONACOT', label:'FONACOT', next:'fonacot'},
      {id:'REGRESAR', label:'REGRESAR', next:'menuPrincipal'}
    ]
  },

  infonavit:{
    type:'question',
    id:'infonavit',
    prompt:'INFONAVIT',
    options:[
      {id:'REQ_INFONAVIT', label:'쮺u치les son los requisitos para obtener un cr칠dito de Infonavit?', next:'req_infonavit'},
      {id:'AVISO_RETENCION', label:'C칩mo puedo obtener mi aviso de retencion y/o actualizacion de factor de descuento?', next:'aviso_infonavit'},
      {id:'REGRESAR', label:'REGRESAR', next:'creditos_externos'}
    ]
  },
  req_infonavit:{ type:'message', id:'accidente_siiab', text:' Accede al siguiente enlace para conocer todos los requisitos que necesitas cumplir para obtener tu cr칠dito INFONAVIT y descubre lo sencillo que es:', attachments:[{type:'link', title:'游 REQUISITOS INFONAVIT', url:'https://shaggyvision.github.io/ado/Requisitos_y_documentos_Comprar.pdf'}]},
  aviso_infonavit:{ type:'message', id:'aviso_infonavit', text:'Desde el portal "Mi cuenta Infonavit" en la opci칩n -Micr칠dito - Aviso de suspenci칩n, Retenci칩n y Modificaci칩n de descuento', attachments:[{type:'video', url:'<iframe src="https://player.vimeo.com/video/1104559004?h=d3bfd28b15" width="340" height="360" frameborder="0" allowfullscreen></iframe>'}]},

  fonacot:{
    type:'question',
    id:'fonacot',
    prompt:'FONACOT',
    options:[
      {id:'REQ_FONACOT', label:'쮺u치les son los requisitos para obtener un cr칠dito Fonacot?', next:'req_fonacot'},
      {id:'CONST_PERCEPCIONES', label:'쮺칩mo puedo obtener una constancia de percepciones?', next:'constancia_percepciones'},
      {id:'REGRESAR', label:'REGRESAR', next:'creditos_externos'}
    ]
  },
  req_fonacot:{ type:'message', id:'accidente_siiab', text:' Accede al siguiente enlace para conocer todos los requisitos que necesitas cumplir para obtener tu cr칠dito FONACOT y descubre lo sencillo que es agendar tu cita de manera r치pida y segura:', attachments:[{type:'link', title:'游 游눯 REQUISITOS FONACOT', url:'https://shaggyvision.github.io/ado/REQFONACOT.pdf'}]},
  constancia_percepciones:{ type:'message', id:'constancia_percepciones', text:'Acude al 치rea de Relaciones industriales de RH para que puedan extenderte dicho documento.'},

}; // end nodes

let historyStack = [];
let currentNode = null;

function presentNode(nodeId, pushToHistory=true)
{

  const node = nodes[nodeId];
  if(!node){
    console.warn('Node not found', nodeId);
    addBotBubble('Lo siento, ocurri칩 un error interno.'); return;
  }
  currentNode = nodeId;

  if(node.type === 'question'){
    addBotBubble(`<strong>${escapeHtml(node.prompt)}</strong>`,
      node.options.map(o=>({label:o.label, next:o.next, primary:false})));
  } else if(node.type === 'message'){
    let html = `<div>${escapeHtml(node.text).replace(/\n/g,'<br>')}</div>`;
    if(node.attachments && node.attachments.length){
      node.attachments.forEach(att=>{
        if(att.type === 'image'){
          html += `<a class="link-card" href="${att.link||att.url}" target="_blank"><img src="${att.url}" alt="" style="max-width:100%;border-radius:6px"><div style="margin-top:6px;font-weight:600"></div></a>`;
        } else if(att.type === 'video'){
          const vimeoUrlMatch = att.url.match(/src="([^"]+)"/);
          const vimeoUrl = vimeoUrlMatch ? vimeoUrlMatch[1] : '';
          html += `<div class="small" style="margin-top:8px">
            <button class="option-btn video-btn" onclick="openLightbox('${vimeoUrl}')">
              <img src="https://shaggyvision.github.io/ado/videos-01.png" alt="Ver video" style="width:180px; height:auto; border:none; cursor:pointer;">
            </button>
          </div>`;
        } else if(att.type === 'link'){
          if(att.url.endsWith('.pdf') || att.url.includes('.pdf')) {
            html += `<button class="option-btn primary" onclick="openPdf('${att.url}')">${escapeHtml(att.title || '游늯 Ver PDF')}</button>`;
          } else {
            html += `<a class="link-card" href="${att.url}" target="_blank">${escapeHtml(att.title||att.url)}</a>`;
          }
        }
      });
    }
    addBotBubble(html, [{label:'REGRESAR', next:'__REGRESAR__', primary:true}]);
  }
}

function handleOption(opt){
  lastInputWasVoice = false;
  addUserBubble(opt.label || opt);
  if(opt.next === '__REGRESAR__' || opt.next === 'REGRESAR'){
    goBack(); return;
  }
  if(currentNode) historyStack.push(currentNode);
  presentNode(opt.next, false);
}

function goBack(){
  if(historyStack.length === 0){ presentNode('main', false); return; }
  const prev = historyStack.pop();
  presentNode(prev, false);
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function start(){
  chatEl.innerHTML = '';
  historyStack = [];
  presentNode('main', false);
  scrollEnd();
}
start();
restartBtn.addEventListener('click', ()=> start());
document.addEventListener('keydown', (e)=>{ if(e.key === 'r' && (e.ctrlKey||e.metaKey)){ start(); } });

/* Speech Synthesis */
const robotFace = document.getElementById('robot-face');
const robotGif = document.getElementById('robot-gif');

function speak(text){
  if(!('speechSynthesis' in window)) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'es-MX';
  utter.pitch = 1.05;
  utter.rate = 1;
  utter.volume = 1;

  utter.onstart = () => { /* could add small visual cue on GIF (not altering GIF) */ };
  utter.onend = () => { };
  window.speechSynthesis.cancel();
  const voices = window.speechSynthesis.getVoices();
  if(voices && voices.length){
    let v = voices.find(v=> /es[-_]?mx/i.test(v.lang) && /female|woman|mujer|female/i.test(v.name));
    if(!v) v = voices.find(v=> /es[-_]?mx/i.test(v.lang));
    if(!v) v = voices.find(v=> /es/i.test(v.lang));
    if(v) utter.voice = v;
  }
  window.speechSynthesis.speak(utter);
}

function speakAndThen(text, cb){
  if(!('speechSynthesis' in window)){
    if(cb) cb(); return;
  }
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'es-MX';
  utter.pitch = 1.05;
  utter.rate = 1;
  utter.volume = 1;
  utter.onend = () => { if(cb) cb(); };
  const voices = window.speechSynthesis.getVoices();
  if(voices && voices.length){
    let v = voices.find(v=> /es[-_]?mx/i.test(v.lang) && /female|woman|mujer|female/i.test(v.name));
    if(!v) v = voices.find(v=> /es[-_]?mx/i.test(v.lang));
    if(!v) v = voices.find(v=> /es/i.test(v.lang));
    if(v) utter.voice = v;
  }
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
}

/* Speech Recognition */
const micBtn = document.getElementById('mic-btn');
const micText = document.getElementById('mic-text');
const micIcon = document.getElementById('mic-icon');

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
let recognition = null;
let listening = false;

if(SpeechRecognition){
  recognition = new SpeechRecognition();
  recognition.lang = 'es-MX';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.continuous = false;

  recognition.onstart = () => {
    listening = true;
    micBtn.classList.add('listening');
    micBtn.setAttribute('aria-pressed','true');
    micText.textContent = 'Escuchando...';
    micIcon.textContent = '游댮';
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    listening = false;
    micBtn.classList.remove('listening');
    micBtn.setAttribute('aria-pressed','false');
    micText.textContent = 'Hablar';
    micIcon.textContent = '游꿗';

    lastInputWasVoice = true;
    addUserBubble(transcript);
    handleSpokenText(transcript);
  };

  recognition.onerror = (ev) => {
    listening = false;
    micBtn.classList.remove('listening');
    micBtn.setAttribute('aria-pressed','false');
    micText.textContent = 'Hablar';
    micIcon.textContent = '游꿗';
    console.error('Speech recognition error', ev);
    addBotBubble('No pude o칤rte bien. Intenta de nuevo por favor.');
  };

  recognition.onend = () => {
    listening = false;
    micBtn.classList.remove('listening');
    micBtn.setAttribute('aria-pressed','false');
    micText.textContent = 'Hablar';
    micIcon.textContent = '游꿗';
  };
} else {
  micBtn.disabled = true;
  micBtn.title = 'Tu navegador no soporta reconocimiento de voz (Web Speech API). Usa un navegador moderno (Chrome/Edge).';
  document.getElementById('mic-indicator').textContent = 'Reconocimiento de voz no disponible en este navegador.';
}

micBtn.addEventListener('click', ()=>{
  if(!recognition) return;
  if(!listening){
    try { recognition.start(); } catch(e){ console.warn(e); }
  } else {
    recognition.stop();
  }
});

/* Contextual Restringido: solo coincidir con opciones del men칰 actual */
function handleSpokenText(text){
  if(!text) return;
  const clean = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[.,!?춰]/g, "");
  console.log("Usuario dijo:", clean);

  // direct commands always allowed
  if(/regresar|volver|atras|inicio|menu/.test(clean)){
    speakAndThen('Regresando al men칰 anterior.', ()=> goBack());
    return;
  }

  // try to match only among current node options
  const restrictedMatch = findBestOptionMatchRestricted(clean);
  if(restrictedMatch){
    const confirmation = `Entend칤 que quieres ${restrictedMatch.label}. Te muestro la informaci칩n.`;
    suppressBotSpeak = true;
    speakAndThen(confirmation, ()=> {
      if(currentNode) historyStack.push(currentNode);
      presentNode(restrictedMatch.next);
    });
    return;
  }

  // If it matches a global mapping but not available in current context, inform the user
  const globalKeywords = {
    'sueldo':['sueldo','nomina','cartera','pago','ganar','mi sueldo','salario','factor'],
    'incentivos':['incentivo','bono','premio','ico','ins','ibecc'],
    'proceso_cova':['cova','siiab','accidente','falla','maquina','tarjeta','liquidacion','deposito','terminal'],
    'infonavit':['infonavit','credito infonavit','retencion','requisitos infonavit','mi cuenta infonavit'],
    'fonacot':['fonacot','credito fonacot','requisitos fonacot','constancia de percepciones'],
    'hablar_asesor':['asesor','hablar','ayuda','persona','whatsapp','contactar']
  };

  for(const key in globalKeywords){
    if(globalKeywords[key].some(k=> clean.includes(k))){
      // found a global intent that's not available in this menu
      const resp = 'Esa opci칩n no est치 disponible en este men칰. Di "Regresar" para volver al men칰 anterior o selecciona una de las opciones visibles.';
      addBotBubble(resp);
      if(lastInputWasVoice) speak(resp);
      lastInputWasVoice = false;
      return;
    }
  }

  // regex-based restricted intents (helpful shortcuts) - check only if they reference allowed keywords in current options
  if(/isr|descuento.*isr/.test(clean)){
    const opt = findBestOptionMatchRestricted('isr');
    if(opt){ return speakAndThen('Te muestro informaci칩n sobre ISR.', ()=> { if(currentNode) historyStack.push(currentNode); presentNode(opt.next); }); }
  }

  // fallback
  const fallback = 'Perd칩n, no entend칤 exactamente. Di el nombre de la opci칩n tal como aparece en pantalla o selecciona uno de los botones.';
  addBotBubble(fallback);
  if(lastInputWasVoice) speak(fallback);
  lastInputWasVoice = false;
}

/* restricted matching: only uses options of the current node */
function findBestOptionMatchRestricted(text){
  const lowered = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  const current = nodes[currentNode];
  if(current && current.options){
    for(const opt of current.options){
      const label = opt.label.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const cleanLabel = label.replace(/[?춰!]/g, '').trim();
      if(lowered.includes(cleanLabel) || cleanLabel.includes(lowered)) return opt;
      const keywords = cleanLabel.split(/\s+/).filter(w => w.length > 3);
      if(keywords.some(w => lowered.includes(w))) return opt;
    }
  }
  return null;
}

function hablar(texto) {
  const synth = window.speechSynthesis;
  const voces = synth.getVoices();

  // Buscar una voz femenina en espa침ol
  const vozFemenina = voces.find(voz =>
    voz.lang.startsWith("es") && voz.name.toLowerCase().includes("female")
  ) || voces.find(voz => voz.lang.startsWith("es"));

  const utterance = new SpeechSynthesisUtterance(texto);
  utterance.voice = vozFemenina;
  synth.speak(utterance);
}

// Ejemplo de uso
document.getElementById("boton-hablar").addEventListener("click", () => {
  hablar("Hola, 쯘n qu칠 puedo ayudarte?");
});



/* end of script */
</script>
<script>
function hablar(texto) {
  const mensaje = new SpeechSynthesisUtterance(texto);
  mensaje.lang = 'es-MX'; // Espa침ol de M칠xico
  speechSynthesis.speak(mensaje);
}
</script></body>
</html>
